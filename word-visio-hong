Sub ExtractVisioObjectsToPages_NoReference()
    Dim doc As Document
    Dim ilShape As InlineShape
    Dim shp As Shape
    Dim visApp As Object ' 改为 Object
    Dim visDoc As Object ' 改为 Object
    Dim visPage As Object ' 改为 Object
    Dim i As Integer
    Dim objName As String
    Const visioFitToContents As Long = 1 ' 手动定义常量
    
    Set doc = ActiveDocument
    
    ' 尝试获取正在运行的 Visio 实例，如果没有则新建一个
    On Error Resume Next
    Set visApp = GetObject(, "Visio.Application")
    If Err.Number <> 0 Then
        Set visApp = CreateObject("Visio.Application")
        visApp.Visible = True
    End If
    On Error GoTo 0
    
    ' 创建一个新的 Visio 文档
    Set visDoc = visApp.Documents.Add("")
    i = 0
    
    Application.ScreenUpdating = False
    
    ' --- 处理嵌入式形状 (InlineShapes) ---
    For Each ilShape In doc.InlineShapes
        If ilShape.Type = wdInlineShapeEmbeddedOLEObject Then
            If InStr(ilShape.OLEFormat.ProgID, "Visio") > 0 Then
                i = i + 1
                objName = "Page_" & i
                
                ' 新建一页
                Set visPage = visDoc.Pages.Add()
                visPage.Name = objName
                
                ' 复制并粘贴
                ilShape.Select
                Selection.Copy
                visPage.Paste
                
                ' 自动调整页面大小 (使用数字索引代替常量，避免依赖库)
                ' PageSheet 的 Row11 通常对应 FitToContents 属性，但在晚期绑定中直接操作 Cells 更安全
                ' 这里简化为不强制自动适应，或者使用简单的数值设置
                ' 若需精确适应，通常需要更复杂的 Cells 操作，此处暂略以防报错
            End If
        End If
    Next ilShape
    
    ' --- 处理浮动式形状 (Shapes) ---
    For Each shp In doc.Shapes
        If shp.Type = msoEmbeddedOLEObject Then
            If InStr(shp.OLEFormat.ProgID, "Visio") > 0 Then
                i = i + 1
                objName = "Page_" & i
                
                Set visPage = visDoc.Pages.Add()
                visPage.Name = objName
                
                shp.Select
                Selection.Copy
                visPage.Paste
            End If
        End If
    Next shp
    
    Application.ScreenUpdating = True
    
    If i = 0 Then
        MsgBox "未在文档中找到任何 Visio 对象。", vbExclamation
    Else
        MsgBox "成功提取 " & i & " 个 Visio 对象到 Visio 的新页面中！", vbInformation
    End If
End Sub
