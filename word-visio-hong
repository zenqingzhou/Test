Sub ExtractVisioObjects_OneByOne()
    Dim doc As Document
    Dim ilShape As InlineShape
    Dim shp As Shape
    Dim visApp As Object
    Dim visDoc As Object
    Dim visPage As Object
    Dim i As Integer
    Dim objName As String
    Dim success As Boolean
    
    ' 初始化
    Set doc = ActiveDocument
    
    ' 启动 Visio
    On Error Resume Next
    Set visApp = GetObject(, "Visio.Application")
    If Err.Number <> 0 Then
        Set visApp = CreateObject("Visio.Application")
        visApp.Visible = True
    End If
    On Error GoTo 0
    
    If visApp Is Nothing Then
        MsgBox "无法启动 Visio。", vbCritical
        Exit Sub
    End If
    
    ' 创建目标文档
    Set visDoc = visApp.Documents.Add("")
    i = 0
    
    Application.ScreenUpdating = False
    
    ' --- 处理 InlineShapes ---
    For Each ilShape In doc.InlineShapes
        If ilShape.Type = wdInlineShapeEmbeddedOLEObject Then
            If InStr(ilShape.OLEFormat.ProgID, "Visio") > 0 Then
                i = i + 1
                objName = "Page_" & i
                
                ' 新建页面
                Set visPage = visDoc.Pages.Add()
                visPage.Name = objName
                
                ' 选中并复制对象
                ilShape.Select
                success = TryCopyWithDelay()
                
                If success Then
                    ' 粘贴到新页面
                    visPage.Paste
                    ' 调整页面大小
                    On Error Resume Next
                    visApp.CommandSet.CmdFitToContents
                    On Error GoTo 0
                Else
                    MsgBox "复制第 " & i & " 个对象失败，跳过。", vbExclamation
                    ' 删除空页面
                    visPage.Delete
                    i = i - 1
                End If
                
                ' 关键：处理完一个对象后，等待较长时间，让系统恢复
                Application.Wait Now + TimeValue("00:00:02") ' 等待 2 秒
            End If
        End If
    Next ilShape
    
    ' --- 处理 Shapes (浮动对象) ---
    For Each shp In doc.Shapes
        If shp.Type = msoEmbeddedOLEObject Then
            If InStr(shp.OLEFormat.ProgID, "Visio") > 0 Then
                i = i + 1
                objName = "Page_" & i
                
                Set visPage = visDoc.Pages.Add()
                visPage.Name = objName
                
                shp.Select
                success = TryCopyWithDelay()
                
                If success Then
                    visPage.Paste
                    On Error Resume Next
                    visApp.CommandSet.CmdFitToContents
                    On Error GoTo 0
                Else
                    MsgBox "复制第 " & i & " 个对象失败，跳过。", vbExclamation
                    visPage.Delete
                    i = i - 1
                End If
                
                Application.Wait Now + TimeValue("00:00:02") ' 等待 2 秒
            End If
        End If
    Next shp
    
    Application.ScreenUpdating = True
    
    MsgBox "完成！成功提取 " & i & " 个对象。", vbInformation
End Sub

' 辅助函数：带延时的复制操作
Function TryCopyWithDelay() As Boolean
    Dim attempts As Integer
    Dim maxAttempts As Integer
    Dim delayMs As Long
    
    maxAttempts = 3
    delayMs = 500 ' 500毫秒延时
    TryCopyWithDelay = False
    
    For attempts = 1 To maxAttempts
        On Error Resume Next
        Selection.Copy
        If Err.Number = 0 Then
            TryCopyWithDelay = True
            Exit For ' 成功则退出循环
        End If
        On Error GoTo 0
        
        ' 失败则延时后重试
        Application.Wait Now + TimeValue("00:00:01") ' 等待 1 秒再试
    Next attempts
End Function
