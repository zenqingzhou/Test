Sub ExtractVisioObjects_ManualCopy_Fixed()
    Dim doc As Document
    Dim ilShape As InlineShape
    Dim shp As Shape
    Dim visApp As Object
    Dim visDoc As Object
    Dim visPage As Object
    Dim i As Integer
    Dim objName As String
    Dim currentShape As Object ' 用于存储当前处理的形状
    Dim shapeType As String ' 'inline' or 'floating'
    Dim allShapes As Collection ' 存储所有 Visio 对象及其类型
    Dim response As VbMsgBoxResult
    Dim cmdSet As Object ' 存储 CommandSet 对象
    
    ' 初始化
    Set doc = ActiveDocument
    Set allShapes = New Collection ' 创建集合存储
    
    ' 启动 Visio
    On Error Resume Next
    Set visApp = GetObject(, "Visio.Application")
    If Err.Number <> 0 Or visApp Is Nothing Then
        Set visApp = CreateObject("Visio.Application")
        If visApp Is Nothing Then
            MsgBox "无法启动 Visio。请确认 Visio 已安装。", vbCritical
            Exit Sub
        End If
        visApp.Visible = True
    End If
    On Error GoTo 0
    
    ' 创建目标文档
    Set visDoc = visApp.Documents.Add("")
    If visDoc Is Nothing Then
        MsgBox "无法创建 Visio 文档。", vbCritical
        Exit Sub
    End If
    
    ' 收集所有 Visio 对象
    For Each ilShape In doc.InlineShapes
        If ilShape.Type = wdInlineShapeEmbeddedOLEObject Then
            If InStr(ilShape.OLEFormat.ProgID, "Visio") > 0 Then
                allShapes.Add Array(ilShape, "inline")
            End If
        End If
    Next ilShape
    
    For Each shp In doc.Shapes
        If shp.Type = msoEmbeddedOLEObject Then
            If InStr(shp.OLEFormat.ProgID, "Visio") > 0 Then
                allShapes.Add Array(shp, "floating")
            End If
        End If
    Next shp
    
    If allShapes.Count = 0 Then
        MsgBox "未找到任何 Visio 对象。", vbExclamation
        Exit Sub
    End If
    
    i = 0
    Application.ScreenUpdating = False
    
    ' 遍历收集到的对象
    For Each item In allShapes
        currentShape = item(0)
        shapeType = item(1)
        i = i + 1
        objName = "Page_" & i
        
        ' 选中当前对象，方便用户复制
        If shapeType = "inline" Then
            currentShape.Select
        ElseIf shapeType = "floating" Then
            currentShape.Select
        End If
        
        ' 弹出提示，让用户手动复制
        response = MsgBox("请手动复制当前选中的 Visio 对象 (对象 " & i & "/" & allShapes.Count & ")。" & vbCrLf & _
                         "选中后按 Ctrl+C，然后点击 '确定' 继续。", vbOKCancel, "手动复制 " & i)
        
        If response = vbCancel Then
            Exit For ' 用户取消
        End If
        
        ' 在 Visio 中新建页面并粘贴
        Set visPage = visDoc.Pages.Add()
        If Not visPage Is Nothing Then
            visPage.Name = objName
            visPage.Paste ' 尝试粘贴剪贴板内容
            
            ' 尝试调整页面大小，增加保护
            On Error Resume Next
            Set cmdSet = visApp.CommandSet ' 获取 CommandSet
            If Not cmdSet Is Nothing Then
                cmdSet.CmdFitToContents ' 调用适应绘图命令
            Else
                ' 如果 CmdFitToContents 不可用，则尝试其他方式或忽略
                ' 例如，可以通过页面属性手动计算边界并设置页面大小，但这很复杂
                ' 这里我们忽略此步骤
            End If
            On Error GoTo 0
        Else
            MsgBox "无法创建新页面，跳过对象 " & i & "。", vbExclamation
        End If
    Next item
    
    Application.ScreenUpdating = True
    
    If i > 0 Then
        MsgBox "手动提取完成！共处理 " & i & " 个对象。", vbInformation
    End If
End Sub
